<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List Application</title>
    <link rel="stylesheet" href="style/index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atomic+Age&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto+Slab:wght@100..900&family=Young+Serif&display=swap" rel="stylesheet">
</head>
<body>
<!-- Background Image Layer -->
<div class="app-bg"></div>

<!-- Water Overlay for Bubbles -->
<div class="water">
    <!-- bubbles will appear here -->
</div>

<div class="container">
    <header>
        <h1>AimTrack</h1>
        <p class="subtitle">Turn Goals into Daily Action</p>
    </header>
    <div class="main-card">
        <div class="add-todo-section">
            <h2 style="margin-bottom: 20px;">Add New Todo</h2>
            <form id="todoForm">
                <div class="input-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" required placeholder="Enter todo title">
                </div>
                <div class="input-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Enter todo description"></textarea>
                </div>
                <div class="input-group">
                    <label for="priority">Priority</label>
                    <select id="priority" name="priority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Todo</button>
            </form>
        </div>
        <div class="filter-section">
            <!--            <strong>Filter:</strong>-->
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="active">Active</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
        </div>
        <div class="todos-section">
            <div class="stats">
                <div class="stat-card total">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card active">
                    <div class="stat-number" id="activeCount">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card completed">
                    <div class="stat-number" id="completedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            <div id="todoList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading todos...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/jquery-3.7.1.min.js"></script>
<script>
    // Fixed: Removed /* from API_URL
    const API_URL = 'http://localhost:8080/Todo_Backend_Web_exploded/api/todos';
    let todos = [];
    let currentFilter = 'all';

    // Load todos on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadTodos();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('todoForm').addEventListener('submit', handleAddTodo);
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderTodos();
            });
        });
    }

    async function loadTodos() {
        const todoList = document.getElementById('todoList');
        todoList.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading todos...</p>
            </div>
        `;
        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            todos = await response.json();
            renderTodos();
        } catch (error) {
            console.error('Error loading todos:', error);
            todoList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <h3>Error loading todos</h3>
                    <p>${error.message}. Check console for details or ensure backend is running.</p>
                </div>
            `;
        }
    }

    async function handleAddTodo(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const todo = {
            title: formData.get('title'),
            description: formData.get('description'),
            priority: formData.get('priority'),
            completed: false
        };
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todo)
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const newTodo = await response.json();
            todos.unshift(newTodo);
            renderTodos();
            e.target.reset();
        } catch (error) {
            console.error('Error creating todo:', error);
            alert('Failed to create todo: ' + error.message);
        }
    }

    async function toggleTodo(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;
        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({...todo, completed: !todo.completed})
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const updatedTodo = await response.json();
            const index = todos.findIndex(t => t.id === id);
            todos[index] = updatedTodo;
            renderTodos();
        } catch (error) {
            console.error('Error updating todo:', error);
            alert('Failed to update todo: ' + error.message);
        }
    }

    async function deleteTodo(id) {
        if (!confirm('Are you sure you want to delete this todo?')) return;
        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            todos = todos.filter(t => t.id !== id);
            renderTodos();
        } catch (error) {
            console.error('Error deleting todo:', error);
            alert('Failed to delete todo: ' + error.message);
        }
    }

    function renderTodos() {
        const filteredTodos = todos.filter(todo => {
            if (currentFilter === 'active') return !todo.completed;
            if (currentFilter === 'completed') return todo.completed;
            return true;
        });
        updateStats();
        const todoList = document.getElementById('todoList');
        if (filteredTodos.length === 0) {
            todoList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No todos found</h3>
                        <p>Add a new todo to get started!</p>
                    </div>
                `;
            return;
        }
        todoList.innerHTML = filteredTodos.map(todo => `
                <div class="todo-item ${todo.completed ? 'completed' : ''} priority-${todo.priority}">
                    <input type="checkbox" class="todo-checkbox"
                           ${todo.completed ? 'checked' : ''}
                           onchange="toggleTodo(${todo.id})">
                    <div class="todo-content">
                        <div class="todo-title">${escapeHtml(todo.title)}</div>
                        ${todo.description ? `<div class="todo-description">${escapeHtml(todo.description)}</div>` : ''}
                        <div class="todo-meta">
                            <span class="badge badge-priority ${todo.priority}">${todo.priority}</span>
                            <span class="badge">${formatDate(todo.createdAt)}</span>
                        </div>
                    </div>
                    <div class="todo-actions">
                        <button class="btn btn-danger" onclick="deleteTodo(${todo.id})">Delete</button>
                    </div>
                </div>
            `).join('');
    }

    function updateStats() {
        document.getElementById('totalCount').textContent = todos.length;
        document.getElementById('activeCount').textContent = todos.filter(t => !t.completed).length;
        document.getElementById('completedCount').textContent = todos.filter(t => t.completed).length;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
</script>

<script>
    const water = document.querySelector('.water');
    function createBubble() {
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        const size = Math.random() * 60 + 20;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${Math.random() * 100}%`;
        const duration = Math.random() * 8 + 4;
        bubble.style.animationDuration = `${duration}s`;
        water.appendChild(bubble);
        setTimeout(() => {
            bubble.remove();
        }, duration * 1000);
    }
    setInterval(createBubble, 300);
</script>
</body>
</html>